(()=>{var t=class{constructor(t=60){this.currentTime=0,this.lastTime=0,this.nextTime=0,this.frameTime=0,this.perfCountFreq=1e3,this.timeElapsed=0,this.fps=0,t&&(this.fps=t,this.frameTime=this.perfCountFreq/this.fps,this.lastTime=new Date().getTime(),this.currentTime=this.lastTime,this.nextTime=this.currentTime+this.frameTime)}start(){this.nextTime=new Date().getTime()+this.frameTime}readyForNextFrame(){return this.currentTime=new Date().getTime(),this.currentTime>this.nextTime&&(this.timeElapsed=this.currentTime-this.lastTime,this.lastTime=this.currentTime,this.nextTime=this.currentTime+this.frameTime,!0)}getTimeElapsed(){return this.currentTime=new Date().getTime(),this.timeElapsed=this.currentTime-this.lastTime,this.lastTime=this.currentTime,this.timeElapsed}},e=class{constructor(t,e){this.x=t,this.y=e}add(t){return this.x+=t.x,this.y+=t.y,this}subtract(t){return this.x-=t.x,this.y-=t.y,this}multiply(t){return this.x*=t,this.y*=t,this}divide(t){return this.x/=t,this.y/=t,this}magnitude(){return Math.sqrt(this.x*this.x+this.y*this.y)}normalize(){return this.divide(this.magnitude())}static dot(t,e){return t.x*e.x+t.y*e.y}static sign(t,e){return t.y*e.x>t.x*e.y?1:-1}};class s{static sort(t,e){return t.dFitness-e.dFitness}constructor(t=[],e=0){this.vecWeights=[],this.dFitness=0,t.length<1?this.dFitness=0:t.length>0&&(this.vecWeights=t,this.dFitness=e)}}var i=class{constructor(t,e,i,n){this.vecPop=[],this.iPopSize=t,this.dMutationRate=e,this.dCrossoverRate=i,this.iChromoLength=n,this.dTotalFitness=0,this.cGeneration=0,this.iFittestGenome=0,this.dBestFitness=0,this.dWorstFitness=99999999,this.dAverageFitness=0;for(let t=0;t<this.iPopSize;t++){this.vecPop.push(new s([],0));for(let e=0;e<this.iChromoLength;e++)this.vecPop[t].vecWeights.push(Math.random())}}mutate(t){for(let e=0;e<t.length;e++)Math.random()<this.dMutationRate&&(t[e]+=(Math.random()-Math.random())*.3)}getChromoRoulette(){let t;let e=Math.random()*this.dTotalFitness,s=0;for(let i=0;i<this.iPopSize;i++)if((s+=this.vecPop[i].dFitness)>=e){t=this.vecPop[i];break}if(void 0===t)throw Error("not a genome!");return t}crossover(t,e,s,i){if(Math.random()>this.dCrossoverRate||t===e){s=t,i=e;return}let n=Math.round(Math.random()*(this.iChromoLength-1));for(let h=0;h<n;h++)s.push(t[h]),i.push(e[h]);for(let h=n;h<t.length;h++)s.push(e[h]),i.push(t[h])}epoch(t){this.vecPop=t,this.reset(),this.vecPop.sort((t,e)=>t.dFitness-e.dFitness),this.calculateBestWorstAvTot();let e=[];for(this.grabNBest(4,1,e);e.length<this.iPopSize;){let t=this.getChromoRoulette(),i=this.getChromoRoulette(),n=[],h=[];this.crossover(t.vecWeights,i.vecWeights,n,h),this.mutate(n),this.mutate(h),e.push(new s(n,0)),e.push(new s(h,0))}return this.vecPop=e,this.vecPop}grabNBest(t,e,s){let i=t;for(;i--;)for(let t=0;t<e;t++)s.push(this.vecPop[this.iPopSize-1-i])}calculateBestWorstAvTot(){this.dTotalFitness=0;let t=0,e=9999999;for(let s=0;s<this.iPopSize;s++)this.vecPop[s].dFitness>t&&(t=this.vecPop[s].dFitness,this.iFittestGenome=s,this.dBestFitness=t),this.vecPop[s].dFitness<e&&(e=this.vecPop[s].dFitness,this.dWorstFitness=e),this.dTotalFitness+=this.vecPop[s].dFitness;this.dAverageFitness=this.dTotalFitness/this.iPopSize}reset(){this.dTotalFitness=0,this.dBestFitness=0,this.dWorstFitness=9999999,this.dAverageFitness=0}getChromos(){return this.vecPop}getGeneration(){return this.cGeneration}averageFitness(){return this.dTotalFitness/this.iPopSize}bestFitness(){return this.dBestFitness}},n=class{constructor(t){this.vecWeight=[],this.numInputs=t;for(let e=0;e<t+1;++e)this.vecWeight.push(Math.random())}},h=class{constructor(t,e){this.vecNeurons=[],this.numNeurons=t,this.numInputsPerNeuron=e;for(let e=0;e<t;e++)this.vecNeurons.push(new n(this.numInputsPerNeuron))}},r=class{constructor(){this.neuronLayers=[],this.numInputs=4,this.numOutputs=2,this.numHiddenLayers=1,this.neuronsPerHiddenLayer=6}createNet(){if(this.numHiddenLayers>0){this.neuronLayers.push(new h(this.neuronsPerHiddenLayer,this.numInputs));for(let t=0;t<this.numHiddenLayers;t++)this.neuronLayers.push(new h(this.neuronsPerHiddenLayer,this.neuronsPerHiddenLayer));this.neuronLayers.push(new h(this.numOutputs,this.neuronsPerHiddenLayer))}else this.neuronLayers.push(new h(this.numOutputs,this.numInputs))}getNumberOfWeights(){let t=0;for(let e=0;e<this.numHiddenLayers;e++)for(let s=0;s<this.neuronLayers[e].numNeurons;s++)for(let i=0;i<this.neuronLayers[e].vecNeurons[s].numInputs;i++)t++;return t}getWeights(){let t=[];for(let e=0;e<this.numHiddenLayers;e++)for(let s=0;s<this.neuronLayers[e].numNeurons;s++)for(let i=0;i<this.neuronLayers[e].vecNeurons[s].numInputs;i++)t.push(this.neuronLayers[e].vecNeurons[s].vecWeight[i]);return t}putWeights(t){let e=0;for(let s=0;s<this.numHiddenLayers;s++)for(let i=0;i<this.neuronLayers[s].numNeurons;i++)for(let n=0;n<this.neuronLayers[s].vecNeurons[i].numInputs;n++)this.neuronLayers[s].vecNeurons[i].vecWeight[n]=t[e++]}update(t){let e=[],s=0;if(t.length!==this.numInputs)return e;for(let i=0;i<this.numHiddenLayers;i++){i>0&&(t=e),e.length=0,s=0;for(let n=0;n<this.neuronLayers[i].numNeurons;n++){let h=0;this.numInputs=this.neuronLayers[i].vecNeurons[n].numInputs;for(let e=0;e<this.numInputs;e++)h+=this.neuronLayers[i].vecNeurons[n].vecWeight[e]*t[s++];h+=-1*this.neuronLayers[i].vecNeurons[n].vecWeight[this.numInputs-1],e.push(this.sigmoid(h,1)),s=0}}return e}sigmoid(t,e){return 1/(1+Math.exp(-1*t/e))}};class o{static #t=(()=>{this.windowWidth=400})();static #e=(()=>{this.windowHeight=400})();static #s=(()=>{this.framesPerSecond=60})();static #i=(()=>{this.numInputs=4})();static #n=(()=>{this.numHidden=1})();static #h=(()=>{this.neuronsPerHiddenLayer=6})();static #r=(()=>{this.numOutputs=2})();static #o=(()=>{this.activationResponse=1})();static #a=(()=>{this.bias=-1})();static #u=(()=>{this.maxTurnRate=.3})();static #c=(()=>{this.maxSpeed=2})();static #l=(()=>{this.sweeperScale=5})();static #m=(()=>{this.numMines=40})();static #d=(()=>{this.numSweepers=30})();static #p=(()=>{this.numTicks=2e3})();static #g=(()=>{this.mineScale=2})();static #_=(()=>{this.crossoverRate=.7})();static #v=(()=>{this.mutationRate=.1})();static #w=(()=>{this.maxPerturbation=.3})();static #f=(()=>{this.numElite=4})();static #y=(()=>{this.numCopiesElite=1})()}class a{constructor(){this._11=0,this._12=0,this._13=0,this._21=0,this._22=0,this._23=0,this._31=0,this._32=0,this._33=0}consumeMatrix(t){this._11=t._11,this._12=t._12,this._13=t._13,this._21=t._21,this._22=t._22,this._23=t._23,this._31=t._31,this._32=t._32,this._33=t._33}TwoDimensionalMatrixMultiply(t){let e=new a;e._11=this._11*t._11+this._12*t._21+this._13*t._31,e._12=this._11*t._12+this._12*t._22+this._13*t._32,e._13=this._11*t._13+this._12*t._23+this._13*t._33,e._21=this._21*t._11+this._22*t._21+this._23*t._31,e._22=this._21*t._12+this._22*t._22+this._23*t._32,e._23=this._21*t._13+this._22*t._23+this._23*t._33,e._31=this._31*t._11+this._32*t._21+this._33*t._31,e._32=this._31*t._12+this._32*t._22+this._33*t._32,e._33=this._31*t._13+this._32*t._23+this._33*t._33,this.consumeMatrix(e)}createIdentity(){let t=new a;return t._11=1,t._22=1,t._33=1,t._12=0,t._13=0,t._21=0,t._23=0,t._31=0,t._32=0,t}translate(t,e){let s=this.createIdentity();s._31=t,s._32=e,this.TwoDimensionalMatrixMultiply(s)}scale(t,e){let s=this.createIdentity();s._11=t,s._22=e,this.TwoDimensionalMatrixMultiply(s)}rotate(t){let e=this.createIdentity(),s=Math.sin(t),i=Math.cos(t);e._11=i,e._12=s,e._21=-s,e._22=i,this.TwoDimensionalMatrixMultiply(e)}transformPoints(t){for(let e=0;e<t.length;e++){let s=this._11*t[e].x+this._21*t[e].y+this._31,i=this._12*t[e].x+this._22*t[e].y+this._32;t[e].x=s,t[e].y=i}}}var u=(t,e,s)=>Math.min(Math.max(t,e),s),c=class{getNumberOfWeights(){return this.brain.getNumberOfWeights()}constructor(){this.brain=new r,this.position=new e(Math.random()*o.windowWidth,Math.random()*o.windowHeight),this.rotation=2*Math.random()*Math.PI,this.lookAt=new e(-1*Math.sin(this.rotation),Math.cos(this.rotation)),this.velocity=0,this.minesFound=0,this.scale=o.sweeperScale,this.closestMine=0,this.leftTrack=.16,this.rightTrack=.16}reset(){this.position=new e(Math.random()*o.windowWidth,Math.random()*o.windowHeight),this.rotation=2*Math.random()*Math.PI,this.minesFound=0}worldTransform(t){let e=new a;e.scale(this.scale,this.scale),e.translate(this.position.x,this.position.y),e.rotate(this.rotation),e.transformPoints(t)}update(t){let e=[],s=this.getClosestMine(t);s.normalize(),e.push(s.x),e.push(s.y),e.push(this.lookAt.x),e.push(this.lookAt.y);let i=this.brain.update(e);if(i.length!==o.numOutputs)throw Error("Outputs length does not match number of outputs");this.leftTrack=i[0],this.rightTrack=i[1];let n=this.leftTrack-this.rightTrack;return n=u(n,-o.maxTurnRate,o.maxTurnRate),this.rotation+=n,this.velocity=this.leftTrack+this.rightTrack,this.lookAt.x=-Math.sin(this.rotation),this.lookAt.y=Math.cos(this.rotation),this.position.add(this.lookAt.multiply(this.velocity)),this.position.x<0&&(this.position.x=o.windowWidth),this.position.x>o.windowWidth&&(this.position.x=0),this.position.y<0&&(this.position.y=o.windowHeight),this.position.y>o.windowHeight&&(this.position.y=0),!0}getClosestMine(t){let e=0,s=Number.MAX_VALUE;for(let i=0;i<t.length;i++){let n=this.position.subtract(t[i]).magnitude();n<s&&(s=n,e=i)}return t[e]}incrementMinesFound(){this.minesFound++}getMinesFound(){return this.minesFound}getPosition(){return this.position}checkForMine(t,e){let s=this.position.subtract(t[this.closestMine]).magnitude();return s<e+5?this.closestMine:-1}incrementFitness(){this.incrementMinesFound()}fitness(){return this.minesFound}putWeights(t){this.brain.putWeights(t)}};let l=Array(16);l[0]=new e(-1,-1),l[1]=new e(-1,1),l[2]=new e(-.5,1),l[3]=new e(-.5,-1),l[4]=new e(.5,-1),l[5]=new e(1,-1),l[6]=new e(1,1),l[7]=new e(.5,1),l[8]=new e(-.5,-.5),l[9]=new e(.5,-.5),l[10]=new e(-.5,.5),l[11]=new e(-.25,.5),l[12]=new e(-.25,1.75),l[13]=new e(.25,1.75),l[14]=new e(.25,.5),l[15]=new e(.5,.5);let m=[,,,,];m[0]=new e(-1,-1),m[1]=new e(-1,1),m[2]=new e(1,1),m[3]=new e(1,-1);var d=class{constructor(){this.vecMines=[],this.sweeperVB=[],this.mineVB=[],this.fastRender=!1,this.iTick=0,this.iGeneration=0,this.vecAvFitness=[],this.vecBestFitness=[];let t=document.createElement("canvas");t.width=800,t.height=600,document.body.appendChild(t),this.canvas=t,this.numberOfSweepers=30,this.numberOfMines=40,this.vecThePopulation=[],this.vecSweepers=[];for(let t=0;t<30;t++)this.vecSweepers.push(new c);this.numberOfWeightsInNN=this.vecSweepers[0].getNumberOfWeights(),this.geneticAlgorithm=new i(this.numberOfSweepers,.1,.7,this.numberOfWeightsInNN),this.vecThePopulation=this.geneticAlgorithm.getChromos();for(let t=0;t<this.numberOfSweepers;t++)this.vecSweepers[t].putWeights(this.vecThePopulation[t].vecWeights);for(let s=0;s<this.numberOfMines;s++)this.vecMines.push(new e(Math.random()*t.width,Math.random()*t.height));for(let t=0;t<l.length;t++)this.sweeperVB.push(l[t]);for(let t=0;t<m.length;t++)this.mineVB.push(m[t])}destroy(){}render(){let t=`Generation: ${this.iGeneration}`,e=this.canvas.getContext("2d");if(e){if(e.fillStyle="white",e.strokeRect(0,0,this.canvas.width,this.canvas.height),e.fill(),e.strokeStyle="black",e.lineWidth=1,e.font="16px arial",e.strokeText(t,5,5),this.fastRender)this.plotStats(e);else{for(let t=0;t<this.numberOfMines;t++){e.beginPath(),e.strokeStyle="green",e.lineWidth=1;let s=JSON.parse(JSON.stringify(this.mineVB));this.worldTransform(s,this.vecMines[t]),e.moveTo(s[0].x,s[0].y);for(let t=1;t<s.length;t++)e.lineTo(s[t].x,s[t].y);e.lineTo(s[0].x,s[0].y),e.stroke(),e.closePath()}e.strokeStyle="red";for(let t=0;t<this.numberOfSweepers;t++){4===t&&(e.strokeStyle="black"),e.beginPath();let s=JSON.parse(JSON.stringify(this.sweeperVB));this.worldTransform(s,this.vecSweepers[t].getPosition()),e.moveTo(s[0].x,s[0].y);for(let t=1;t<s.length;t++)e.lineTo(s[t].x,s[t].y);e.lineTo(s[0].x,s[0].y),e.stroke(),e.closePath()}}}}worldTransform(t,e){let s=new a;s.scale(2,2),s.translate(e.x,e.y),s.transformPoints(t)}update(){if(this.iTick++<2e3)for(let t=0;t<this.numberOfSweepers;t++){if(!this.vecSweepers[t].update(this.vecMines))return console.log("error in update, wrong amount of NN inputs"),!1;let s=this.vecSweepers[t].checkForMine(this.vecMines,2);s>=0&&(this.vecSweepers[t].incrementFitness(),this.vecMines[s]=new e(Math.random()*this.canvas.width,Math.random()*this.canvas.height)),this.vecThePopulation[t].dFitness=this.vecSweepers[t].fitness()}else{this.vecAvFitness.push(this.geneticAlgorithm.averageFitness()),this.vecBestFitness.push(this.geneticAlgorithm.bestFitness()),this.iGeneration++,this.iTick=0,this.vecThePopulation=this.geneticAlgorithm.epoch(this.vecThePopulation);for(let t=0;t<this.numberOfSweepers;t++)this.vecSweepers[t].putWeights(this.vecThePopulation[t].vecWeights),this.vecSweepers[t].reset()}return!0}plotStats(t){if(!t)return;let e=`Best Fitness: ${this.geneticAlgorithm.bestFitness()}`,s=`Average Fitness: ${this.geneticAlgorithm.averageFitness()}`;t.font="16px arial",t.strokeText(e,5,5),t.strokeText(s,5,25),t.strokeStyle="black",t.lineWidth=1,t.beginPath(),t.moveTo(0,0),t.lineTo(0,200),t.lineTo(200,200),t.stroke(),t.closePath(),t.strokeStyle="red",t.beginPath(),t.moveTo(0,200);for(let e=0;e<this.vecAvFitness.length;e++)t.lineTo(e,200-this.vecAvFitness[e]);t.stroke(),t.closePath(),t.strokeStyle="blue",t.beginPath(),t.moveTo(0,200);for(let e=0;e<this.vecBestFitness.length;e++)t.lineTo(e,200-this.vecBestFitness[e]);t.stroke(),t.closePath()}getFastRender(){return this.fastRender}setFastRender(t){this.fastRender=t}fastRenderToggler(){this.fastRender=!this.fastRender}};class p{constructor(){}static getInstance(){return p.instance||(p.instance=new p),p.instance}static #t=(()=>{this.messageQueue=[]})();static pushMessage(t){p.messageQueue.push(t)}static popMessage(){return p.messageQueue.length>0&&p.messageQueue.pop(),""}static peekMessage(){return p.messageQueue.length>0?p.messageQueue[p.messageQueue.length-1]:""}}class g{static getInstance(){return g.instance||(g.instance=new g),g.instance}static messageProcesser(){switch(p.popMessage()){case"start":g.getInstance().controller=new d;break;case"paint":g.getInstance().controller.render();break;case"quit":g.getInstance().done=!0}}constructor(){this.controller=new d,this.done=!1;let e=new t(60);for(e.start();!this.done;){for(;""!==p.peekMessage();)g.messageProcesser();e.readyForNextFrame()&&(this.controller.update()||(console.error("Error in controller update"),this.done=!0),p.pushMessage("paint"))}}}g.getInstance()})();
//# sourceMappingURL=index.js.map
